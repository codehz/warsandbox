import*as e from"../web_modules/three.js";import*as o from"./utils.js";import*as n from"./inputmanager.js";import{VoxelTextureManager as E}from"./texture.js";export async function main(r,s,d,u){const B=4,k=new E(B,16);await k.add("assets/bedrock.png"),await k.add("assets/test.png");const w=new e.MeshStandardMaterial({map:k.getTexture(),side:e.FrontSide});w.map.minFilter=e.NearestFilter,w.map.magFilter=e.NearestFilter,console.time("init");const c=await o.fetchModule("native/engine.wasm",{}),i=o.readMapInfo(c.mapInfo);console.log(i),console.timeLog("init","fetch"),c.loadSampleMap(),console.timeLog("init","load map"),c.initEngine(),console.timeLog("init","init engine"),c.initPlayer(),console.timeLog("init","init player");const M=o.readUint16(c.blockTextureCount),I=o.getUint16BufferFromSlice(c.blockTextureMapping,M*2);for(let t=0;t<M;t++)I[t]=t;o.writeUint16(c.blockTextureBase,B),console.timeEnd("init");const W=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(i.chunkWidth,i.chunkWidth,i.chunkHeight)),F=new e.Sphere(new e.Vector3(i.chunkWidth/2,i.chunkWidth/2,i.chunkHeight/2),((i.chunkWidth/2)**2+(i.chunkWidth/2)**2+(i.chunkHeight/2)**2)**.5);console.time("geo");const H=[];for(let t=0;t<i.length;t++)for(let a=0;a<i.width;a++){const x=c.generateGeomentryDataForChunk(a,t),f=o.readMap(i,x),y=f.data.proxy(new e.InterleavedBuffer(f.data.data,8)),m=new e.BufferGeometry(),A=f.indices.proxy(new e.BufferAttribute(f.indices.data,1));m.setIndex(A),m.setAttribute("position",new e.InterleavedBufferAttribute(y,3,0)),m.setAttribute("normal",new e.InterleavedBufferAttribute(y,3,3)),m.setAttribute("uv",new e.InterleavedBufferAttribute(y,2,6)),m.boundingBox=W,m.boundingSphere=F;const h=new e.Mesh(m,w);h.castShadow=!0,h.receiveShadow=!0,h.position.add(new e.Vector3(a*i.chunkWidth,t*i.chunkWidth,0)),r.add(h),H.push(h);var S=new e.BoxHelper(h,16776960);r.add(S)}console.timeEnd("geo");const b=new e.Mesh(new e.BoxGeometry(1.001,1.001,1.001),new e.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));b.renderOrder=998,r.add(b);let p=!0;setInterval(()=>{if(p)return;c.tick();const t=o.readCameraInfo(c.cameraInfo);L(b,t.highlight,t.selectedFace),v=+new Date()},50),c.tick();let v=+new Date();d.setAnimationLoop(()=>{if(p)return;const t=(+new Date()-v)/50;t>.1&&t<1&&c.microtick(t);const a=o.readCameraInfo(c.cameraInfo);s.position.set(a.pos[0],a.pos[1],a.pos[2]+1.7);const x=a.rot[1],f=a.rot[0];s.rotation.set(Math.PI/2+x,0,f,"YZX"),s.matrixWorldNeedsUpdate=!0,u(),d.render(r,s)});const l=o.getControlMapper(c.control),g=new o.KeyboardMapper(l);n.detect([87,38],t=>g.up=t),n.detect([83,40],t=>g.down=t),n.detect([65,37],t=>g.left=t),n.detect([68,39],t=>g.right=t),n.detect([32],t=>l.jump=t),n.detect([16],t=>l.sneak=t),n.detect([17],t=>l.boost=t),n.detect([0],t=>l.use1=t),n.detect([1],t=>l.use2=t),n.detect([2],t=>l.use3=t),C(t=>p=!t),document.onmousemove=t=>{if(p)return;l.rotate=[-t.movementX/100,-t.movementY/100]}}function L(r,s,d){if(r.position.set(s[0]+.5,s[1]+.5,s[2]+.5),d>5)return;for(let u=0;u<6;u++)u!=d?(r.geometry.faces[u*2].color.setHex(65280),r.geometry.faces[u*2+1].color.setHex(65280)):(r.geometry.faces[u*2].color.setHex(16711935),r.geometry.faces[u*2+1].color.setHex(16711935));r.geometry.colorsNeedUpdate=!0}function C(r){document.onfullscreenchange=d=>{document.fullscreenElement?document.body.requestPointerLock():(r(!1),document.body.onclick=s)},document.onfullscreenerror=d=>{console.warn(d),r(!1)},document.onpointerlockchange=d=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}r(!0)}else r(!1),document.body.onclick=s};const s=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=s}
