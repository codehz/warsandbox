import*as t from"../web_modules/three.js";import*as n from"./utils.js";import*as o from"./inputmanager.js";import{VoxelTextureManager as E}from"./texture.js";export async function main(r,d,l,u){const B=4,w=new E(B,16);await w.add("assets/bedrock.png"),await w.add("assets/test.png");const p=new t.MeshPhongMaterial({map:w.getTexture(),side:t.FrontSide});p.map.minFilter=t.NearestFilter,p.map.magFilter=t.NearestFilter,p.map.flipY=!1,console.time("init");const s=await n.fetchModule("native/engine.wasm",{}),i=n.readMapInfo(s.mapInfo);console.log(i),console.timeLog("init","fetch"),s.loadSampleMap(),console.timeLog("init","load map"),s.initEngine(),console.timeLog("init","init engine"),s.initPlayer(),console.timeLog("init","init player");const M=n.readUint16(s.blockTextureCount),S=n.getUint16BufferFromSlice(s.blockTextureMapping,M*2);for(let e=0;e<M;e++)S[e]=e;n.writeUint16(s.blockTextureBase,B),console.timeEnd("init");const I=new t.Box3(new t.Vector3(0,0,0),new t.Vector3(i.chunkWidth,i.chunkWidth,i.chunkHeight)),W=new t.Sphere(new t.Vector3(i.chunkWidth/2,i.chunkWidth/2,i.chunkHeight/2),((i.chunkWidth/2)**2+(i.chunkWidth/2)**2+(i.chunkHeight/2)**2)**.5);console.time("geo");const F=[];for(let e=0;e<i.length;e++)for(let a=0;a<i.width;a++){const x=s.generateGeomentryDataForChunk(a,e),f=n.readMap(i,x),y=f.data.proxy(new t.InterleavedBuffer(f.data.data,8)),m=new t.BufferGeometry(),A=f.indices.proxy(new t.BufferAttribute(f.indices.data,1));m.setIndex(A),m.setAttribute("position",new t.InterleavedBufferAttribute(y,3,0)),m.setAttribute("normal",new t.InterleavedBufferAttribute(y,3,3)),m.setAttribute("uv",new t.InterleavedBufferAttribute(y,2,6)),m.boundingBox=I,m.boundingSphere=W;const h=new t.Mesh(m,p);h.castShadow=!0,h.receiveShadow=!0,h.position.add(new t.Vector3(a*i.chunkWidth,e*i.chunkWidth,0)),r.add(h),F.push(h);var H=new t.BoxHelper(h,16776960);r.add(H)}console.timeEnd("geo");const b=new t.Mesh(new t.BoxGeometry(1.001,1.001,1.001),new t.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));b.renderOrder=998,r.add(b);let g=!0;setInterval(()=>{if(g)return;s.tick();const e=n.readCameraInfo(s.cameraInfo);L(b,e.highlight,e.selectedFace),v=+new Date()},50),s.tick();let v=+new Date();l.setAnimationLoop(()=>{if(g)return;const e=(+new Date()-v)/50;e>.1&&e<1&&s.microtick(e);const a=n.readCameraInfo(s.cameraInfo);d.position.set(a.pos[0],a.pos[1],a.pos[2]+1.7);const x=a.rot[1],f=a.rot[0];d.rotation.set(Math.PI/2+x,0,f,"YZX"),d.matrixWorldNeedsUpdate=!0,u(),l.render(r,d)});const c=n.getControlMapper(s.control),k=new n.KeyboardMapper(c);o.detect([87,38],e=>k.up=e),o.detect([83,40],e=>k.down=e),o.detect([65,37],e=>k.left=e),o.detect([68,39],e=>k.right=e),o.detect([32],e=>c.jump=e),o.detect([16],e=>c.sneak=e),o.detect([17],e=>c.boost=e),o.detect([0],e=>c.use1=e),o.detect([1],e=>c.use2=e),o.detect([2],e=>c.use3=e),o.detect([49],e=>c.selectedSlot=0),o.detect([50],e=>c.selectedSlot=1),o.detect([51],e=>c.selectedSlot=2),o.detect([52],e=>c.selectedSlot=3),o.detect([53],e=>c.selectedSlot=4),o.detect([54],e=>c.selectedSlot=5),o.detect([55],e=>c.selectedSlot=6),o.detect([56],e=>c.selectedSlot=7),C(e=>g=!e),document.onmousemove=e=>{if(g)return;c.rotate=[-e.movementX/100,-e.movementY/100]}}function L(r,d,l){if(r.position.set(d[0]+.5,d[1]+.5,d[2]+.5),l>5)return;for(let u=0;u<6;u++)u!=l?(r.geometry.faces[u*2].color.setHex(65280),r.geometry.faces[u*2+1].color.setHex(65280)):(r.geometry.faces[u*2].color.setHex(16711935),r.geometry.faces[u*2+1].color.setHex(16711935));r.geometry.colorsNeedUpdate=!0}function C(r){document.onfullscreenchange=l=>{document.fullscreenElement?document.body.requestPointerLock():(r(!1),document.body.onclick=d)},document.onfullscreenerror=l=>{console.warn(l),r(!1)},document.onpointerlockchange=l=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}r(!0)}else r(!1),document.body.onclick=d};const d=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=d}
