import*as t from"../web_modules/three.js";import*as n from"./utils.js";import*as o from"./inputmanager.js";import{VoxelTextureManager as P}from"./texture.js";import{createParticleSystem as j}from"./particle.js";export async function main(r,a,l,u){const B=4,k=new P(B,16);await k.add("assets/bedrock.png"),await k.add("assets/test.png");const p=new t.MeshPhongMaterial({map:k.getTexture(),side:t.FrontSide});p.map.minFilter=t.NearestFilter,p.map.magFilter=t.NearestFilter,p.map.flipY=!1,console.time("init");const i=await n.fetchModule("native/engine.wasm",{}),s=n.readMapInfo(i.mapInfo);console.log(s),console.timeLog("init","fetch"),i.loadSampleMap(),console.timeLog("init","load map"),i.initEngine(),console.timeLog("init","init engine"),i.initPlayer(),console.timeLog("init","init player");const I=n.readUint16(i.blockTextureCount),S=n.getUint16BufferFromSlice(i.blockTextureMapping,I*2);for(let e=0;e<I;e++)S[e]=e;n.writeUint16(i.blockTextureBase,B),console.timeEnd("init");const W=new t.Box3(new t.Vector3(0,0,0),new t.Vector3(s.chunkWidth,s.chunkWidth,s.chunkHeight)),F=new t.Sphere(new t.Vector3(s.chunkWidth/2,s.chunkWidth/2,s.chunkHeight/2),((s.chunkWidth/2)**2+(s.chunkWidth/2)**2+(s.chunkHeight/2)**2)**.5);console.time("geo");const H=[];for(let e=0;e<s.length;e++)for(let d=0;d<s.width;d++){const x=i.generateGeomentryDataForChunk(d,e),f=n.readMap(s,x),b=f.data.proxy(new t.InterleavedBuffer(f.data.data,8)),m=new t.BufferGeometry(),L=f.indices.proxy(new t.BufferAttribute(f.indices.data,1));m.setIndex(L),m.setAttribute("position",new t.InterleavedBufferAttribute(b,3,0)),m.setAttribute("normal",new t.InterleavedBufferAttribute(b,3,3)),m.setAttribute("uv",new t.InterleavedBufferAttribute(b,2,6)),m.boundingBox=W,m.boundingSphere=F;const h=new t.Mesh(m,p);h.castShadow=!0,h.receiveShadow=!0,h.position.add(new t.Vector3(d*s.chunkWidth,e*s.chunkWidth,0)),r.add(h),H.push(h);var A=new t.BoxHelper(h,16776960);r.add(A)}console.timeEnd("geo");const y=new t.Mesh(new t.BoxGeometry(1.001,1.001,1.001),new t.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));y.renderOrder=998,r.add(y);const v=n.readParticleInfo(i.particle),E=j(v.proxy(new t.InterleavedBuffer(v.data,7)));r.add(E);let g=!0;setInterval(()=>{if(g)return;i.tick();const e=n.readCameraInfo(i.cameraInfo);C(y,e.highlight,e.selectedFace),M=+new Date()},50),i.tick();let M=+new Date();l.setAnimationLoop(()=>{if(g)return;const e=(+new Date()-M)/50;e>.1&&e<1&&i.microtick(e);const d=n.readCameraInfo(i.cameraInfo);a.position.set(d.pos[0],d.pos[1],d.pos[2]+1.7);const x=d.rot[1],f=d.rot[0];a.rotation.set(Math.PI/2+x,0,f,"YZX"),a.matrixWorldNeedsUpdate=!0,u(),l.render(r,a)});const c=n.getControlMapper(i.control),w=new n.KeyboardMapper(c);o.detect([87,38],e=>w.up=e),o.detect([83,40],e=>w.down=e),o.detect([65,37],e=>w.left=e),o.detect([68,39],e=>w.right=e),o.detect([32],e=>c.jump=e),o.detect([16],e=>c.sneak=e),o.detect([17],e=>c.boost=e),o.detect([0],e=>c.use1=e),o.detect([1],e=>c.use2=e),o.detect([2],e=>c.use3=e),o.detect([49],e=>c.selectedSlot=0),o.detect([50],e=>c.selectedSlot=1),o.detect([51],e=>c.selectedSlot=2),o.detect([52],e=>c.selectedSlot=3),o.detect([53],e=>c.selectedSlot=4),o.detect([54],e=>c.selectedSlot=5),o.detect([55],e=>c.selectedSlot=6),o.detect([56],e=>c.selectedSlot=7),T(e=>g=!e),document.onmousemove=e=>{if(g)return;c.rotate=[-e.movementX/100,-e.movementY/100]}}function C(r,a,l){if(r.position.set(a[0]+.5,a[1]+.5,a[2]+.5),l>5)return;for(let u=0;u<6;u++)u!=l?(r.geometry.faces[u*2].color.setHex(65280),r.geometry.faces[u*2+1].color.setHex(65280)):(r.geometry.faces[u*2].color.setHex(16711935),r.geometry.faces[u*2+1].color.setHex(16711935));r.geometry.colorsNeedUpdate=!0}function T(r){document.onfullscreenchange=l=>{document.fullscreenElement?document.body.requestPointerLock():(r(!1),document.body.onclick=a)},document.onfullscreenerror=l=>{console.warn(l),r(!1)},document.onpointerlockchange=l=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}r(!0)}else r(!1),document.body.onclick=a};const a=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=a}
