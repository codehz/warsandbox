import*as e from"../web_modules/three.js";import*as i from"./utils.js";import*as o from"./inputmanager.js";import{VoxelTextureManager as A}from"./texture.js";export async function main(n,c,d,u){const w=new A(2,16);await w.add("assets/bedrock.png"),await w.add("assets/test.png");const k=new e.MeshStandardMaterial({map:w.getTexture(),side:e.FrontSide});k.map.minFilter=e.NearestFilter,k.map.magFilter=e.NearestFilter,console.time("init");const s=await i.fetchModule("native/engine.wasm",{}),r=i.readMapInfo(s.mapInfo);console.log(r),console.timeLog("init","fetch"),s.loadSampleMap(),console.timeLog("init","load map"),s.initEngine(),console.timeLog("init","init engine"),s.initPlayer(),console.timeLog("init","init player"),console.timeEnd("init");const B=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(r.chunkWidth,r.chunkWidth,r.chunkHeight)),M=new e.Sphere(new e.Vector3(r.chunkWidth/2,r.chunkWidth/2,r.chunkHeight/2),((r.chunkWidth/2)**2+(r.chunkWidth/2)**2+(r.chunkHeight/2)**2)**.5);console.time("geo");const I=[];for(let t=0;t<r.length;t++)for(let a=0;a<r.width;a++){const b=s.generateGeomentryDataForChunk(a,t),h=i.readMap(r,b),x=h.data.proxy(new e.InterleavedBuffer(h.data.data,8)),m=new e.BufferGeometry(),H=h.indices.proxy(new e.BufferAttribute(h.indices.data,1));m.setIndex(H),m.setAttribute("position",new e.InterleavedBufferAttribute(x,3,0)),m.setAttribute("normal",new e.InterleavedBufferAttribute(x,3,3)),m.setAttribute("uv",new e.InterleavedBufferAttribute(x,2,6)),m.boundingBox=B,m.boundingSphere=M;const f=new e.Mesh(m,k);f.castShadow=!0,f.receiveShadow=!0,f.position.add(new e.Vector3(a*r.chunkWidth,t*r.chunkWidth,0)),n.add(f),I.push(f);var W=new e.BoxHelper(f,16776960);n.add(W)}console.timeEnd("geo");const y=new e.Mesh(new e.BoxGeometry(1.001,1.001,1.001),new e.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));y.renderOrder=998,n.add(y);let p=!0;setInterval(()=>{if(p)return;s.tick();const t=i.readCameraInfo(s.cameraInfo);E(y,t.highlight,t.selectedFace),v=+new Date()},50),s.tick();let v=+new Date();d.setAnimationLoop(()=>{if(p)return;const t=(+new Date()-v)/50;t>.1&&t<1&&s.microtick(t);const a=i.readCameraInfo(s.cameraInfo);c.position.set(a.pos[0],a.pos[1],a.pos[2]+1.7);const b=a.rot[1],h=a.rot[0];c.rotation.set(Math.PI/2+b,0,h,"YZX"),c.matrixWorldNeedsUpdate=!0,u(),d.render(n,c)});const l=i.getControlMapper(s.control),g=new i.KeyboardMapper(l);o.detect([87,38],t=>g.up=t),o.detect([83,40],t=>g.down=t),o.detect([65,37],t=>g.left=t),o.detect([68,39],t=>g.right=t),o.detect([32],t=>l.jump=t),o.detect([16],t=>l.sneak=t),o.detect([17],t=>l.boost=t),o.detect([0],t=>l.use1=t),o.detect([1],t=>l.use2=t),o.detect([2],t=>l.use3=t),F(t=>p=!t),document.onmousemove=t=>{if(p)return;l.rotate=[-t.movementX/100,-t.movementY/100]}}function E(n,c,d){if(n.position.set(c[0]+.5,c[1]+.5,c[2]+.5),d>5)return;for(let u=0;u<6;u++)u!=d?(n.geometry.faces[u*2].color.setHex(65280),n.geometry.faces[u*2+1].color.setHex(65280)):(n.geometry.faces[u*2].color.setHex(16711935),n.geometry.faces[u*2+1].color.setHex(16711935));n.geometry.colorsNeedUpdate=!0}function F(n){document.onfullscreenchange=d=>{document.fullscreenElement?document.body.requestPointerLock():(n(!1),document.body.onclick=c)},document.onfullscreenerror=d=>{console.warn(d),n(!1)},document.onpointerlockchange=d=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}n(!0)}else n(!1),document.body.onclick=c};const c=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=c}
