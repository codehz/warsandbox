import*as e from"../web_modules/three.js";import*as a from"./utils.js";import*as o from"./inputmanager.js";function E(n){return new Promise((i,s)=>{n.onLoad=i,n.onError=s})}export async function main(n,i,s,u){const M=new e.LoadingManager(),x=new e.TextureLoader(M),w=new e.MeshPhongMaterial({map:x.load("assets/test.png"),side:e.FrontSide});w.map.minFilter=e.LinearMipmapLinearFilter,w.map.magFilter=e.NearestFilter,await E(M),console.time("init");const d=await a.fetchModule("native/engine.wasm",{}),r=a.readMapInfo(d.mapInfo);console.log(r),console.timeLog("init","fetch"),d.loadSampleMap(),console.timeLog("init","load map"),d.initEngine(),console.timeLog("init","init engine"),d.initPlayer(),console.timeLog("init","init player"),console.timeEnd("init");const B=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(r.chunkWidth,r.chunkWidth,r.chunkHeight)),L=new e.Sphere(new e.Vector3(r.chunkWidth/2,r.chunkWidth/2,r.chunkHeight/2),((r.chunkWidth/2)**2+(r.chunkWidth/2)**2+(r.chunkHeight/2)**2)**.5);console.time("geo");for(let t=0;t<r.width;t++)for(let c=0;c<r.length;c++){const y=d.generateGeomentryDataForChunk(t,c),h=a.readMap(r,y),b=h.data.proxy(new e.InterleavedBuffer(h.data.data,8)),m=new e.BufferGeometry(),W=h.indices.proxy(new e.BufferAttribute(h.indices.data,1));m.setIndex(W),m.setAttribute("position",new e.InterleavedBufferAttribute(b,3,0)),m.setAttribute("normal",new e.InterleavedBufferAttribute(b,3,3)),m.setAttribute("uv",new e.InterleavedBufferAttribute(b,2,6)),m.boundingBox=B,m.boundingSphere=L;const f=new e.Mesh(m,w);f.castShadow=!0,f.receiveShadow=!0,f.position.add(new e.Vector3(t*r.chunkWidth,c*r.chunkWidth,0)),n.add(f);var I=new e.BoxHelper(f,16776960);n.add(I)}console.timeEnd("geo");const k=new e.Mesh(new e.BoxGeometry(1.001,1.001,1.001),new e.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));k.renderOrder=998,n.add(k);let g=!0;setInterval(()=>{if(g)return;d.tick(),v=+new Date()},50),d.tick();let v=+new Date();s.setAnimationLoop(()=>{if(g)return;const t=(+new Date()-v)/50;t>.1&&t<1&&d.microtick(t);const c=a.readCameraInfo(d.cameraInfo);i.position.set(c.pos[0],c.pos[1],c.pos[2]+1.7);const y=c.rot[1],h=c.rot[0];F(k,c.highlight,c.selectedFace),i.rotation.set(Math.PI/2+y,0,h,"YZX"),i.matrixWorldNeedsUpdate=!0,u(),s.render(n,i)});const l=a.getControlMapper(d.control),p=new a.KeyboardMapper(l);o.detect([87,38],t=>p.up=t),o.detect([83,40],t=>p.down=t),o.detect([65,37],t=>p.left=t),o.detect([68,39],t=>p.right=t),o.detect([32],t=>l.jump=t),o.detect([16],t=>l.sneak=t),o.detect([17],t=>l.boost=t),o.detect([0],t=>l.use1=t),o.detect([1],t=>l.use2=t),o.detect([2],t=>l.use3=t),H(t=>g=!t),document.onmousemove=t=>{if(g)return;l.rotate=[-t.movementX/100,-t.movementY/100]}}function F(n,i,s){if(n.position.set(i[0]+.5,i[1]+.5,i[2]+.5),s>5)return;for(let u=0;u<6;u++)u!=s?(n.geometry.faces[u*2].color.setHex(65280),n.geometry.faces[u*2+1].color.setHex(65280)):(n.geometry.faces[u*2].color.setHex(16711935),n.geometry.faces[u*2+1].color.setHex(16711935));n.geometry.colorsNeedUpdate=!0}function H(n){document.onfullscreenchange=s=>{document.fullscreenElement?document.body.requestPointerLock():(n(!1),document.body.onclick=i)},document.onfullscreenerror=s=>{console.warn(s),n(!1)},document.onpointerlockchange=s=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}n(!0)}else n(!1),document.body.onclick=i};const i=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=i}
