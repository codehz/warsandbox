import*as e from"../web_modules/three.js";import*as a from"./utils.js";import*as n from"./inputmanager.js";function E(r){return new Promise((c,s)=>{r.onLoad=c,r.onError=s})}export async function main(r,c,s,v){const b=new e.LoadingManager(),B=new e.TextureLoader(b),g=new e.MeshPhongMaterial({map:B.load("assets/test.png"),side:e.FrontSide});g.map.minFilter=e.LinearMipmapLinearFilter,g.map.magFilter=e.NearestFilter,await E(b),console.time("init");const d=await a.fetchModule("native/engine.wasm",{}),o=a.readMapInfo(d.mapInfo);console.log(o),console.timeLog("init","fetch"),d.loadSampleMap(),console.timeLog("init","load map"),d.initEngine(),console.timeLog("init","init engine"),d.initPlayer(),console.timeLog("init","init player"),console.timeEnd("init");const L=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(o.chunkWidth,o.chunkWidth,o.chunkHeight)),I=new e.Sphere(new e.Vector3(o.chunkWidth/2,o.chunkWidth/2,o.chunkHeight/2),((o.chunkWidth/2)**2+(o.chunkWidth/2)**2+(o.chunkHeight/2)**2)**.5);console.time("geo");for(let t=0;t<o.width;t++)for(let i=0;i<o.length;i++){const k=d.generateGeomentryDataForChunk(t,i),m=a.readMap(o,k),y=m.data.proxy(new e.InterleavedBuffer(m.data.data,8)),l=new e.BufferGeometry(),W=m.indices.proxy(new e.BufferAttribute(m.indices.data,1));l.setIndex(W),l.setAttribute("position",new e.InterleavedBufferAttribute(y,3,0)),l.setAttribute("normal",new e.InterleavedBufferAttribute(y,3,3)),l.setAttribute("uv",new e.InterleavedBufferAttribute(y,2,6)),l.boundingBox=L,l.boundingSphere=I;const h=new e.Mesh(l,g);h.castShadow=!0,h.receiveShadow=!0,h.position.add(new e.Vector3(t*o.chunkWidth,i*o.chunkWidth,0)),r.add(h);var x=new e.BoxHelper(h,16776960);r.add(x)}console.timeEnd("geo");var w=new e.Mesh(new e.BoxGeometry(1.001,1.001,1.001),new e.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1}));w.renderOrder=999,r.add(w);let p=!0;setInterval(()=>{if(p)return;d.tick(),M=+new Date()},50),d.tick();let M=+new Date();s.setAnimationLoop(()=>{if(p)return;const t=(+new Date()-M)/50;t>.1&&t<1&&d.microtick(t);const i=a.readCameraInfo(d.cameraInfo);c.position.set(i.pos[0],i.pos[1],i.pos[2]+1.7);const k=i.rot[1],m=i.rot[0];w.position.set(i.highlight[0]+.5,i.highlight[1]+.5,i.highlight[2]+.5),c.rotation.set(Math.PI/2+k,0,m,"YZX"),c.matrixWorldNeedsUpdate=!0,v(),s.render(r,c)});const u=a.getControlMapper(d.control),f=new a.KeyboardMapper(u);n.detect([87,38],t=>f.up=t),n.detect([83,40],t=>f.down=t),n.detect([65,37],t=>f.left=t),n.detect([68,39],t=>f.right=t),n.detect([32],t=>u.jump=t),n.detect([16],t=>u.sneak=t),n.detect([17],t=>u.boost=t),n.detect([0],t=>u.use1=t),n.detect([1],t=>u.use2=t),n.detect([2],t=>u.use3=t),A(t=>p=!t),document.onmousemove=t=>{if(p)return;u.rotate=[-t.movementX/100,-t.movementY/100]}}function A(r){document.onfullscreenchange=s=>{document.fullscreenElement?document.body.requestPointerLock():(r(!1),document.body.onclick=c)},document.onfullscreenerror=s=>{console.warn(s),r(!1)},document.onpointerlockchange=s=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}r(!0)}else r(!1),document.body.onclick=c};const c=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=c}
