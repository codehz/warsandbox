import*as e from"../web_modules/three.js";import*as c from"./utils.js";import*as o from"./inputmanager.js";function F(n){return new Promise((i,s)=>{n.onLoad=i,n.onError=s})}export async function main(n,i,s,u){const M=new e.LoadingManager(),B=new e.TextureLoader(M),w=new e.MeshPhongMaterial({map:B.load("assets/test.png"),side:e.FrontSide});w.map.minFilter=e.LinearMipmapLinearFilter,w.map.magFilter=e.NearestFilter,await F(M),console.time("init");const d=await c.fetchModule("native/engine.wasm",{}),r=c.readMapInfo(d.mapInfo);console.log(r),console.timeLog("init","fetch"),d.loadSampleMap(),console.timeLog("init","load map"),d.initEngine(),console.timeLog("init","init engine"),d.initPlayer(),console.timeLog("init","init player"),console.timeEnd("init");const I=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(r.chunkWidth,r.chunkWidth,r.chunkHeight)),L=new e.Sphere(new e.Vector3(r.chunkWidth/2,r.chunkWidth/2,r.chunkHeight/2),((r.chunkWidth/2)**2+(r.chunkWidth/2)**2+(r.chunkHeight/2)**2)**.5);console.time("geo");const v=[];for(let t=0;t<r.length;t++)for(let a=0;a<r.width;a++){const y=d.generateGeomentryDataForChunk(a,t),f=c.readMap(r,y),b=f.data.proxy(new e.InterleavedBuffer(f.data.data,8)),m=new e.BufferGeometry(),E=f.indices.proxy(new e.BufferAttribute(f.indices.data,1));m.setIndex(E),m.setAttribute("position",new e.InterleavedBufferAttribute(b,3,0)),m.setAttribute("normal",new e.InterleavedBufferAttribute(b,3,3)),m.setAttribute("uv",new e.InterleavedBufferAttribute(b,2,6)),m.boundingBox=I,m.boundingSphere=L;const h=new e.Mesh(m,w);h.castShadow=!0,h.receiveShadow=!0,h.position.add(new e.Vector3(a*r.chunkWidth,t*r.chunkWidth,0)),n.add(h),v.push(h);var W=new e.BoxHelper(h,16776960);n.add(W)}console.timeEnd("geo");const k=new e.Mesh(new e.BoxGeometry(1.001,1.001,1.001),new e.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));k.renderOrder=998,n.add(k);let p=!0;setInterval(()=>{if(p)return;d.tick();const t=c.readCameraInfo(d.cameraInfo);H(k,t.highlight,t.selectedFace);for(const a of r.dirtymap())v[a].geometry.attributes.position.needsUpdate=!0;x=+new Date()},50),d.tick();let x=+new Date();s.setAnimationLoop(()=>{if(p)return;const t=(+new Date()-x)/50;t>.1&&t<1&&d.microtick(t);const a=c.readCameraInfo(d.cameraInfo);i.position.set(a.pos[0],a.pos[1],a.pos[2]+1.7);const y=a.rot[1],f=a.rot[0];i.rotation.set(Math.PI/2+y,0,f,"YZX"),i.matrixWorldNeedsUpdate=!0,u(),s.render(n,i)});const l=c.getControlMapper(d.control),g=new c.KeyboardMapper(l);o.detect([87,38],t=>g.up=t),o.detect([83,40],t=>g.down=t),o.detect([65,37],t=>g.left=t),o.detect([68,39],t=>g.right=t),o.detect([32],t=>l.jump=t),o.detect([16],t=>l.sneak=t),o.detect([17],t=>l.boost=t),o.detect([0],t=>l.use1=t),o.detect([1],t=>l.use2=t),o.detect([2],t=>l.use3=t),A(t=>p=!t),document.onmousemove=t=>{if(p)return;l.rotate=[-t.movementX/100,-t.movementY/100]}}function H(n,i,s){if(n.position.set(i[0]+.5,i[1]+.5,i[2]+.5),s>5)return;for(let u=0;u<6;u++)u!=s?(n.geometry.faces[u*2].color.setHex(65280),n.geometry.faces[u*2+1].color.setHex(65280)):(n.geometry.faces[u*2].color.setHex(16711935),n.geometry.faces[u*2+1].color.setHex(16711935));n.geometry.colorsNeedUpdate=!0}function A(n){document.onfullscreenchange=s=>{document.fullscreenElement?document.body.requestPointerLock():(n(!1),document.body.onclick=i)},document.onfullscreenerror=s=>{console.warn(s),n(!1)},document.onpointerlockchange=s=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}n(!0)}else n(!1),document.body.onclick=i};const i=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=i}
