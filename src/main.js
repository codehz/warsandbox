import*as e from"../web_modules/three.js";import*as c from"./utils.js";import*as n from"./inputmanager.js";function F(o){return new Promise((i,a)=>{o.onLoad=i,o.onError=a})}export async function main(o,i,a,u){const M=new e.LoadingManager(),x=new e.TextureLoader(M),w=new e.MeshPhongMaterial({map:x.load("assets/test.png"),side:e.FrontSide});w.map.minFilter=e.LinearMipmapLinearFilter,w.map.magFilter=e.NearestFilter,await F(M),console.time("init");const s=await c.fetchModule("native/engine.wasm",{}),r=c.readMapInfo(s.mapInfo);console.log(r),console.timeLog("init","fetch"),s.loadSampleMap(),console.timeLog("init","load map"),s.initEngine(),console.timeLog("init","init engine"),s.initPlayer(),console.timeLog("init","init player"),console.timeEnd("init");const B=new e.Box3(new e.Vector3(0,0,0),new e.Vector3(r.chunkWidth,r.chunkWidth,r.chunkHeight)),I=new e.Sphere(new e.Vector3(r.chunkWidth/2,r.chunkWidth/2,r.chunkHeight/2),((r.chunkWidth/2)**2+(r.chunkWidth/2)**2+(r.chunkHeight/2)**2)**.5);console.time("geo");const L=[];for(let t=0;t<r.length;t++)for(let d=0;d<r.width;d++){const y=s.generateGeomentryDataForChunk(d,t),h=c.readMap(r,y),b=h.data.proxy(new e.InterleavedBuffer(h.data.data,8)),m=new e.BufferGeometry(),E=h.indices.proxy(new e.BufferAttribute(h.indices.data,1));m.setIndex(E),m.setAttribute("position",new e.InterleavedBufferAttribute(b,3,0)),m.setAttribute("normal",new e.InterleavedBufferAttribute(b,3,3)),m.setAttribute("uv",new e.InterleavedBufferAttribute(b,2,6)),m.boundingBox=B,m.boundingSphere=I;const f=new e.Mesh(m,w);f.castShadow=!0,f.receiveShadow=!0,f.position.add(new e.Vector3(d*r.chunkWidth,t*r.chunkWidth,0)),o.add(f),L.push(f);var W=new e.BoxHelper(f,16776960);o.add(W)}console.timeEnd("geo");const k=new e.Mesh(new e.BoxGeometry(1.001,1.001,1.001),new e.MeshBasicMaterial({color:16777215,opacity:.5,transparent:!0,depthWrite:!1,vertexColors:!0}));k.renderOrder=998,o.add(k);let p=!0;setInterval(()=>{if(p)return;s.tick();const t=c.readCameraInfo(s.cameraInfo);H(k,t.highlight,t.selectedFace),v=+new Date()},50),s.tick();let v=+new Date();a.setAnimationLoop(()=>{if(p)return;const t=(+new Date()-v)/50;t>.1&&t<1&&s.microtick(t);const d=c.readCameraInfo(s.cameraInfo);i.position.set(d.pos[0],d.pos[1],d.pos[2]+1.7);const y=d.rot[1],h=d.rot[0];i.rotation.set(Math.PI/2+y,0,h,"YZX"),i.matrixWorldNeedsUpdate=!0,u(),a.render(o,i)});const l=c.getControlMapper(s.control),g=new c.KeyboardMapper(l);n.detect([87,38],t=>g.up=t),n.detect([83,40],t=>g.down=t),n.detect([65,37],t=>g.left=t),n.detect([68,39],t=>g.right=t),n.detect([32],t=>l.jump=t),n.detect([16],t=>l.sneak=t),n.detect([17],t=>l.boost=t),n.detect([0],t=>l.use1=t),n.detect([1],t=>l.use2=t),n.detect([2],t=>l.use3=t),A(t=>p=!t),document.onmousemove=t=>{if(p)return;l.rotate=[-t.movementX/100,-t.movementY/100]}}function H(o,i,a){if(o.position.set(i[0]+.5,i[1]+.5,i[2]+.5),a>5)return;for(let u=0;u<6;u++)u!=a?(o.geometry.faces[u*2].color.setHex(65280),o.geometry.faces[u*2+1].color.setHex(65280)):(o.geometry.faces[u*2].color.setHex(16711935),o.geometry.faces[u*2+1].color.setHex(16711935));o.geometry.colorsNeedUpdate=!0}function A(o){document.onfullscreenchange=a=>{document.fullscreenElement?document.body.requestPointerLock():(o(!1),document.body.onclick=i)},document.onfullscreenerror=a=>{console.warn(a),o(!1)},document.onpointerlockchange=a=>{if(document.pointerLockElement){try{navigator.keyboard.lock()}catch{}o(!0)}else o(!1),document.body.onclick=i};const i=()=>{document.body.onclick=null,document.fullscreenElement?document.body.requestPointerLock():document.body.requestFullscreen({navigationUI:"hide"})};document.body.onclick=i}
